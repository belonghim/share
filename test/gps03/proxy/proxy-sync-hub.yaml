#---
#apiVersion: v1
#data:
#  ca-bundle.crt: |
#    {{ ( fromSecret "openshift-ingress-operator" "router-ca" "tls.crt" ) | base64dec | autoindent }}
#kind: ConfigMap
#metadata:
#  name: router-bundle
#  namespace: policies
---
apiVersion: policy.open-cluster-management.io/v1
kind: ConfigurationPolicy
metadata:
  name: proxy-sync-hub
spec:
  remediationAction: enforce
  severity: high
  object-templates-raw: |
    {{- $ca := fromConfigMap "openshift-config" "router-bundle" "ca-bundle.crt" }}
    - complianceType: musthave
      objectDefinition:
        apiVersion: v1
        data:
          ca-bundle.crt: |-
            {{- if contains "## openshift-ingress-operator router-ca start" $ca }}{{ (splitn "## openshift-ingress-operator router-ca start" 2 $ca)._0 | autoindent }}{{- end }}## openshift-ingress-operator router-ca start
            {{ ( fromSecret "openshift-ingress-operator" "router-ca" "tls.crt" ) | base64dec | autoindent }}
            ## openshift-ingress-operator router-ca end{{- if contains "## openshift-ingress-operator router-ca end" $ca }}{{ (splitn "## openshift-ingress-operator router-ca end" 2 $ca)._1 | autoindent }}{{- end }}
        kind: ConfigMap
        metadata:
          name: router-bundle
          namespace: openshift-config
---
apiVersion: v1
data:
  ca-bundle.crt: |
    {{ ( fromConfigMap "openshift-config" "router-bundle" "ca-bundle.crt" ) | autoindent }}
kind: ConfigMap
metadata:
  name: router-bundle
  namespace: policies
---
apiVersion: config.openshift.io/v1
kind: Proxy
metadata:
  name: cluster
spec:
  trustedCA:
    name: router-bundle
---
