apiVersion: policy.open-cluster-management.io/v1
kind: ConfigurationPolicy
metadata:
  name: localblock-odf-persistent-volume
spec:
  remediationAction: inform
  severity: high
  object-templates-raw: |
    {{- range $nd := (lookup "v1" "Node" "" "" "cluster.ocs.openshift.io/openshift-storage=").items }}
    {{- range $pv := (lookup "v1" "PersistentVolume" "" "" ( (cat "kubernetes.io/hostname=" $nd.metadata.name ", storage.openshift.com/local-volume-owner-name=localblock-odf") | replace " " "")).items }}
    - complianceType: musthave
      objectDefinition:
        apiVersion: v1
        kind: PersistentVolume
        metadata:
          name: {{ $pv.metadata.name }}
        spec:
          accessModes:
          - ReadWriteOnce
          storageClassName: localblock-odf
          volumeMode: Block
          nodeAffinity:
            required:
              nodeSelectorTerms:
              - matchExpressions:
                - key: kubernetes.io/hostname
                  operator: In
                  values:
                  - {{ $nd.metadata.name }}
        status:
          phase: Available
    {{- end }}
    {{- end }}
---
