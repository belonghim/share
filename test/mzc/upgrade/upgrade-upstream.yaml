---
apiVersion: policy.open-cluster-management.io/v1
kind: ConfigurationPolicy
metadata:
  name: upgrade-upstream
spec:
  remediationAction: enforce
  severity: high
  object-templates-raw: |
    {{- if eq (lookup "cluster.open-cluster-management.io/v1alpha1" "ClusterClaim" "" "policies.release-repo").kind "ClusterClaim" }}
    {{hub $cm := (cat "upgrade-osus-" (index .ManagedClusterLabels "policies.release-repo") | replace " " "") hub}}
    {{hub $gr := fromConfigMap "policies" $cm "graphUrl" hub}}
    - complianceType: musthave
      objectDefinition:
        apiVersion: config.openshift.io/v1
        kind: ClusterVersion
        metadata:
          name: version
        spec:
          upstream: {{hub $gr hub}}
        status:
          conditions:
          - status: 'True'
            type: RetrievedUpdates
    {{- end }}
---
