# Cluster 업그레이드 절차 정리 (by policies)

![tempFileForShare_20241127-144946.png](https://github.com/user-attachments/assets/6d1d3f30-12e7-42df-88cf-add96596ad7a)

## Mirror Images

### Download Images
```
## Operators Images
$ mkdir redhat
$ cat >redhat/redhat.yaml <<EOF
kind: ImageSetConfiguration
apiVersion: mirror.openshift.io/v1alpha2
mirror:
  operators:
  - catalog: registry.redhat.io/redhat/redhat-operator-index:v4.14
    packages:
    - name: advanced-cluster-management
      channels:
      - name: release-2.11
      - name: release-2.10
      - name: release-2.9
        minVersion: 2.9.3
    - name: multicluster-engine
      channels:
      - name: stable-2.6
      - name: stable-2.5
      - name: stable-2.4
        minVersion: 2.4.4
    - name: local-storage-operator
      channels:
      - name: stable
        minVersion: 4.14.0-202409240108
    - name: lvms-operator
      channels:
      - name: stable-4.14
        minVersion: 4.14.6
    - name: servicemeshoperator
      channels:
      - name: stable
        minVersion: 2.6.1
    - name: kiali-ossm
      channels:
      - name: candidate
      - name: stable
        minVersion: 1.89.1
    - name: jaeger-product
      channels:
      - name: stable
        minVersion: 1.34.1-5
    - name: tempo-product
      channels:
      - name: stable
        minVersion: 0.10.0-8
    - name: netobserv-operator
      channels:
      - name: stable
        minVersion: 1.3.0
    - name: node-observability-operator
      channels:
      - name: alpha
        minVersion: 0.2.0
    - name: openshift-gitops-operator
      channels:
      - name: latest
      - name: gitops-1.13
        minVersion: 1.13.1
    - name: cincinnati-operator
      channels:
      - name: v1
        minVersion: 5.0.2
    - name: cluster-logging
      channels:
      - name: stable-6.0
      - name: stable-5.9
      - name: stable-5.8
        minVersion: 5.8.14
    - name: kubernetes-nmstate-operator
      channels:
      - name: stable
        minVersion: 4.14.0-202409250809
    - name: node-healthcheck-operator
      channels:
      - name: stable
      - name: 4.16-eus
        minVersion: 0.8.1
    - name: self-node-remediation
      channels:
      - name: stable
      - name: 4.16-eus
        minVersion: 0.8.0
    - name: node-maintenance-operator
      channels:
      - name: stable
      - name: 4.14-eus
        minVersion: 5.2.1
    - name: openshift-custom-metrics-autoscaler-operator
      channels:
      - name: stable
        minVersion: 2.11.2-322
    - name: opentelemetry-product
      channels:
      - name: stable
        minVersion: 0.89.0-3
    - name: web-terminal
      channels:
      - name: fast
        minVersion: 1.6.0
    - name: devworkspace-operator
      channels:
      - name: fast
        minVersion: 0.20.0
    - name: vertical-pod-autoscaler
      channels:
      - name: stable
        minVersion: 4.14.0-202403221232
  - catalog: registry.redhat.io/redhat/redhat-operator-index:v4.15
    packages:
    - name: advanced-cluster-management
    - name: multicluster-engine
    - name: local-storage-operator
    - name: lvms-operator
    - name: servicemeshoperator
    - name: kiali-ossm
    - name: jaeger-product
    - name: tempo-product
    - name: netobserv-operator
    - name: node-observability-operator
    - name: openshift-gitops-operator
    - name: cincinnati-operator
    - name: cluster-logging
    - name: kubernetes-nmstate-operator
    - name: node-healthcheck-operator
    - name: self-node-remediation
    - name: node-maintenance-operator
    - name: openshift-custom-metrics-autoscaler-operator
    - name: opentelemetry-product
    - name: web-terminal
    - name: devworkspace-operator
    - name: vertical-pod-autoscaler
  - catalog: registry.redhat.io/redhat/redhat-operator-index:v4.16
    packages:
    - name: advanced-cluster-management
    - name: multicluster-engine
    - name: local-storage-operator
    - name: lvms-operator
    - name: servicemeshoperator
    - name: kiali-ossm
    - name: jaeger-product
    - name: tempo-product
    - name: netobserv-operator
    - name: node-observability-operator
    - name: openshift-gitops-operator
    - name: cincinnati-operator
    - name: cluster-logging
    - name: kubernetes-nmstate-operator
    - name: node-healthcheck-operator
    - name: self-node-remediation
    - name: node-maintenance-operator
    - name: openshift-custom-metrics-autoscaler-operator
    - name: opentelemetry-product
    - name: web-terminal
    - name: devworkspace-operator
    - name: vertical-pod-autoscaler
EOF

$ cat >1.sh <<\EOF
RPN=$(basename $(realpath $1))
[ $? -ne 0 ] && echo "Example: 1.sh <dir>" && exit 1
echo $$ >$1/1.pid
unset ok;while [ "$ok" != "true" ]; do oc-mirror --config=$1/$RPN.yaml file://$1 --ignore-history --continue-on-error >$1/$RPN.out 2>&1
if grep -v ": manifest unknown" $1/$RPN.out | grep error: ; then mv $1/$RPN.out $1/$RPN.out.$(date +%Y%m%d_%H%M);rm -rf $1/mirror_seq1_000000.tar
else ok=true; break; fi; done
rm -f $1/$RPN.out.$(date +%Y)* $1/1.pid
EOF

$ nohup sh 1.sh redhat >redhat/1.out 2>&1 &

... Release images skip ...

```

***

... Bring in ...

***

### Upload Images
```
## Operators images
$ cat >2.sh <<\EOF
[ "$1" = "" ] && echo "Example: 2.sh <Repository>" && exit 1
echo $$ >2.pid
unset ok; while [ "$ok" != "true" ]; do oc-mirror --from mirror_seq1_000000.tar docker://$1 --skip-metadata-check >2-1.out 2>&1
if grep error: 2-1.out ; then mv 2-1.out 2-1.out.$(date +%Y%m%d_%H%M)
else ok=true; break; fi; done
rm -f 2-1.out.$(date +%Y)* 2.pid
EOF

$ Repository=$HOSTNAME:8443/olm-redhat
$ nohup sh 2.sh $Repository >2.out 2>&1 &

... Release images skip ...

```


## Release Upgrade

### Download the git repo
```
$ git clone https://github.com/belonghim/share
$ cd share/policies/script

```

### Add Release Signatures
```
## Test adding-signuatures script
$ export SIGNATURES=/opt/signatures
$ sh adding-signatures.sh
..

## Apply adding-signuatures
$ sh adding-signatures.sh | oc apply -f -
..

```

### Apply policies.osus label
```
## Apply policies.osus label is "ocp4"
$ CLUSTER=local-cluster
$ oc label mcl $CLUSTER policies.osus=ocp4

```

### Check policies.cv states are all "Compliant"
```
## Check cv-check state is "Compliant"
$ oc -n $CLUSTER get policy -l policies.cv
NAME                               REMEDIATION ACTION   COMPLIANCE STATE   AGE
policies.check-cv                  inform               Compliant          3h14m
policies.check-upgradeable         inform               Compliant          3h14m
policies.proxy-sync-managed        enforce              Compliant          3h14m
policies.upgrade-admin-acks        enforce              Compliant          3h14m
policies.upgrade-release-channel   enforce              Compliant          3h14m
policies.upgrade-signatures        enforce              Compliant          3h14m
policies.upgrade-sub-automatic     enforce              Compliant          75m
policies.upgrade-upstream          enforce              Compliant          3h14m

```

### Change release channel
```
## Change managecluster's release-channel label
$ CHANNEL=eus-4.18
$ oc label mcl $CLUSTER policies.release-channel=${CHANNEL} --overwrite

```

### Wait channel update
```
## Wait until channel is updated
$ oc -n $CLUSTER wait --timeout=10m --for=jsonpath='{.status.distributionInfo.ocp.channel}'=${CHANNEL} managedclusterinfo $CLUSTER
managedclusterinfo.internal.open-cluster-management.io/compact condition met

```

### Delete release channel
```
## Delete managecluster's release-channel label
$ oc label mcl $CLUSTER policies.release-channel-

```

### Execute version upgrade curator
```
## set $CLUSTER variable
$ export CLUSTER=local-cluster

## Check available release versions
$ oc -n $CLUSTER get -ojsonpath='{.status.distributionInfo.ocp.availableUpdates}' managedclusterinfo $CLUSTER
...

## set $VERSION variable
$ export VERSION=4.18.1

$ oc -n $CLUSTER wait --timeout=20m --for=jsonpath='{.status.distributionInfo.ocp.availableUpdates[?(@=="'$VERSION'")]}' managedclusterinfo $CLUSTER
managedclusterinfo.internal.open-cluster-management.io/local-cluster condition met

## Check check-upgradeable state is "Compliant"
$ oc -n $CLUSTER get policy policies.check-upgradeable
NAME                         REMEDIATION ACTION   COMPLIANCE STATE   AGE
policies.check-upgradeable   inform               Compliant          13h

## Recreate curator-upgrade
$ sh upgrade.sh | oc replace --force -f -

```

### Wait version upgrade
```
## Wait until curator-upgrade is updated
$ oc -n $CLUSTER wait --timeout=3h --for=condition=clustercurator-job=true clustercurator $CLUSTER
clustercurator.cluster.open-cluster-management.io/local-cluster condition met

## Check clustercurator state is "Job_failed"
$ oc -n $CLUSTER get clustercurator $CLUSTER -ojsonpath='{.status.conditions[?(@.type=="clustercurator-job")].reason}' | grep Job_failed

## If the clustercurator state is "Job_failed", recreate curator-upgrade (Repeat "Wait until curator-upgrade is updated")
$ [ $? -eq 0 ] && sh upgrade.sh | oc replace --force -f -

## Wait until upgrade version is updated
$ oc -n $CLUSTER wait --timeout=1h --for=jsonpath='{.status.distributionInfo.ocp.version}'=${VERSION} managedclusterinfo $CLUSTER

```

### Wait ClusterVersion compliant
```
## Wait until check-cv state is "Compliant"
$ oc -n $CLUSTER wait --timeout=1h --for=jsonpath='{.status.compliant}'=Compliant policy policies.check-cv
policy.policy.open-cluster-management.io/policies.check-cv condition met

```


<br><br>

## Operators Upgrade (to latest)

### (Optional) Manual Subscription
```
## Example of Subscription that should not be upgrade
#apiVersion: operators.coreos.com/v1alpha1
#kind: Subscription
#metadata:
#  labels:
#    policies.ignore: ""
#..
#spec:
#  installPlanApproval: Manual
#..

```

### Check csv-check template compliant
```
## Check check-csv's state
$ oc -n $CLUSTER get policy policies.check-csv
NAME                 REMEDIATION ACTION   COMPLIANCE STATE   AGE
policies.check-csv   inform               NonCompliant       15h

```

### Change installPlanApproval to automatic
```
## Change managecluster's sub-approval label to automatic
$ oc label --overwrite managedcluster $CLUSTER policies.sub-approval=automatic
managedcluster.cluster.open-cluster-management.io/local-cluster labeled

## Check upgrade-sub-automatic state is "Compliant"
$ oc -n $CLUSTER get policy policies.upgrade-sub-automatic
NAME                                  REMEDIATION ACTION   COMPLIANCE STATE   AGE
policies.upgrade-sub-automatic        enforce              Compliant          3m13s

```

### Wait ClusterServiceVersion compliant
```
## Wait for 5 minuates
$ sleep 300

## Check target cluster's policies state
$ oc -n $CLUSTER get policy
..

## Wait until policies.csv states are all "Compliant"
$ oc -n $CLUSTER wait --timeout=1h --for=jsonpath='{.status.compliant}'=Compliant policy -l policies.csv
policy.policy.open-cluster-management.io/policies.check-csv condition met
policy.policy.open-cluster-management.io/policies.check-cv condition met
policy.policy.open-cluster-management.io/policies.install-operators condition met
policy.policy.open-cluster-management.io/policies.upgrade-cs-redhat-operator condition met
policy.policy.open-cluster-management.io/policies.upgrade-marketplace-job condition met
policy.policy.open-cluster-management.io/policies.upgrade-sub-automatic condition met

```

### Change installPlanApproval to manual
```
## Change managecluster's sub-approval label to manual
$ oc label --overwrite managedcluster $CLUSTER policies.sub-approval=manual
managedcluster.cluster.open-cluster-management.io/local-cluster labeled

## Check upgrade-sub-manual state is "Compliant"
$ oc -n $CLUSTER get policy policies.upgrade-sub-manual
NAME                               REMEDIATION ACTION   COMPLIANCE STATE   AGE
policies.upgrade-sub-manual        enforce              Compliant          22s

```



