# Cluster 업그레이드 절차 정리 (by policies)

## Preparation

### Mirror Images
```
... skip ...
```


## Release Upgrade

### Add Release Signatures
```
## Create adding-signuatures script
$ cat > adding-signatures.sh <<\EOF
SIGNATURES=/data01/temp/mirror/release-414a-416a/result/release-signatures/
oc create -f ${SIGNATURES} --dry-run=client -oyaml | sed 's/openshift-config-managed/policies/g'
EOF

## Test adding-signuatures script
$ sh adding-signatures.sh
..

## Apply adding-signuatures
$ sh adding-signatures.sh | oc apply -f -
..

```

### Check ClusterVersion
```
## Check cv-inf-check state is "Compliant"
$ CLUSTER=local-cluster
$ oc -n $CLUSTER get policy policies.cv-inf-check
NAME                    REMEDIATION ACTION   COMPLIANCE STATE   AGE
policies.cv-inf-check   inform               Compliant          39h

```

### Execute channel update curator
```
## Create curator-channel script
$ cat > curator-channel.sh <<\EOF
CLUSTER=$1
CHANNEL=eus-4.16
cat <<EOF
apiVersion: cluster.open-cluster-management.io/v1beta1
kind: ClusterCurator
metadata:
  name: $CLUSTER
  namespace: $CLUSTER
spec:
  desiredCuration: upgrade
  upgrade:
    channel: $CHANNEL
EOF

## Test curator-channel script
$ CLUSTER=local-cluster
$ sh curator-channel.sh $CLUSTER
..

## Recreate curator-channel
$ CLUSTER=local-cluster
$ sh curator-channel.sh $CLUSTER | oc replace --force -f -
..

```

### Wait channel update
```
## Wait until curator-channel is updated
$ CLUSTER=local-cluster
$ oc -n $CLUSTER wait --timeout=5m --for=condition=clustercurator-job=true clustercurator $CLUSTER
clustercurator.cluster.open-cluster-management.io/local-cluster condition met

```

### Execute version upgrade curator
```
## Create curator-upgrade script
$ cat > curator-upgrade.sh <<\EOF
CLUSTER=$1
VERSION=4.15.35
cat <<EOF
apiVersion: cluster.open-cluster-management.io/v1beta1
kind: ClusterCurator
metadata:
  name: $CLUSTER
  namespace: $CLUSTER
spec:
  desiredCuration: upgrade
  upgrade:
    desiredUpdate: $VERSION
EOF

## Test curator-upgrade script
$ CLUSTER=local-cluster
$ sh curator-upgrade.sh $CLUSTER
..

## Recreate curator-upgrade
$ CLUSTER=local-cluster
$ sh curator-upgrade.sh $CLUSTER | oc replace --force -f -
..

```

### Wait version upgrade
```
## Wait until curator-upgrade is updated
$ CLUSTER=local-cluster
$ oc -n $CLUSTER wait --timeout=2h --for=condition=clustercurator-job=true clustercurator $CLUSTER
clustercurator.cluster.open-cluster-management.io/local-cluster condition met

```

### Wait ClusterVersion
```
## Wait until cv-inf-check state is "Compliant"
$ CLUSTER=local-cluster
$ oc -n $CLUSTER wait --timeout=1h --for=jsonpath='{.status.compliant}'=Compliant policy policies.cv-inf-check
policy.policy.open-cluster-management.io/policies.cv-inf-check condition met

```


## Operators Upgrade (to latest)

### Manual Subscription (optional)
```
## Example of Subscription that should not be upgrade
apiVersion: operators.coreos.com/v1alpha1
kind: Subscription
metadata:
  labels:
    policies.ignore: ""
..
spec:
  installPlanApproval: Manual
..

```

### Change installPlanApproval to automatic
```
## Change managecluster's sub-approval label to automatic
$ CLUSTER=local-cluster
$ oc label --overwrite managedcluster $CLUSTER policies.sub-approval=automatic
managedcluster.cluster.open-cluster-management.io/local-cluster labeled

## Check sub-enf-approval-automatic state is "Compliant"
$ CLUSTER=local-cluster
$ oc -n $CLUSTER get policy policies.sub-enf-approval-automatic
NAME                                  REMEDIATION ACTION   COMPLIANCE STATE   AGE
policies.sub-enf-approval-automatic   enforce              Compliant          3m13s

```

### Wait ClusterServiceVersion
```
## Wait until csv-inf-check state is "Compliant"
$ CLUSTER=local-cluster
$ oc -n $CLUSTER wait --timeout=2h --for=jsonpath='{.status.compliant}'=Compliant policy policies.csv-inf-check
policy.policy.open-cluster-management.io/policies.csv-inf-check condition met

```

### Change installPlanApproval to manual
```
## Change managecluster's sub-approval label to manual
$ CLUSTER=local-cluster
$ oc label --overwrite managedcluster $CLUSTER policies.sub-approval=manual
managedcluster.cluster.open-cluster-management.io/local-cluster labeled

## Check sub-enf-approval-manual state is "Compliant"
$ CLUSTER=local-cluster
$ oc -n $CLUSTER get policy policies.sub-enf-approval-manual
NAME                               REMEDIATION ACTION   COMPLIANCE STATE   AGE
policies.sub-enf-approval-manual   enforce              Compliant          22s

```
